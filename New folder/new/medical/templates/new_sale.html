{% load static %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>New Sale</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://unpkg.com/htmx.org@1.5.0"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            background: url("{% static 'images/sn.jpeg' %}") no-repeat center center fixed;
            background-color: #f4f4f4;
            padding: 20px;
            background-size: cover;
        }

        .container {
            background: rgba(241, 246, 245, 0.726);
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
            width: 700px;
        }

        label {
            font-weight: bold;
            margin-top: 10px;
        }

        .hidden {
            display: none;
        }

        input[type="text"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            margin-bottom: 15px;
            width: 100%;
            box-sizing: border-box;
        }

        h1 {
            text-align: center;
        }

        .btn {
            padding: 10px 20px;
            border-radius: 5px;
        }

        .button-group {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

        .add-tablet-btn {
            align-self: flex-start;
        }

        #customer-image {
        display: block;
        margin: 0 auto; /* Center the image */
        max-width: 100%;
        max-height: 100px; /* Set a maximum height */
        margin-bottom: 20px; /* Add some space below the image */
    }

        .home-button {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: #245be6d2;
            border: none;
            color: #fff;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            padding: 5px 10px;
            border-radius: 4px;
            text-decoration: none;
        }

        .home-button svg {
            margin-right: 8px;
            fill: #fff;
        }

        .home-button:hover {
            background-color: #0859bc;
            text-decoration: none;
        }
    </style>
</head>

<body hx-headers='{"X-CSRFToken":"{{ csrf_token }}"}'>
    <button class="home-button" onclick="window.location.href='{% url 'admin_dashboard' %}'">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-box-arrow-left"
            viewBox="0 0 16 16">
            <path fill-rule="evenodd"
                d="M6 12.5a.5.5 0 0 0 .5.5h8a.5.5 0 0 0 .5-.5v-9a.5.5 0 0 0-.5-.5h-8a.5.5 0 0 0-.5.5v2a.5.5 0 0 1-1 0v-2A1.5 1.5 0 0 1 6.5 2h8A1.5 1.5 0 0 1 16 3.5v9a1.5 1.5 0 0 1-1.5 1.5h-8A1.5 1.5 0 0 1 5 12.5v-2a.5.5 0 0 1 1 0z" />
            <path fill-rule="evenodd"
                d="M.146 8.354a.5.5 0 0 1 0-.708l3-3a.5.5 0 1 1 .708.708L1.707 7.5H10.5a.5.5 0 0 1 0 1H1.707l2.147 2.146a.5.5 0 0 1-.708.708z" />
        </svg>
        Sale
    </button>

    <img id="customer-image" src="{% static 'path_to_default_image.jpg' %}" alt="">


    <div class="container">
        <h1>New Sale</h1>
        <form action="" method="POST" id="sa">
            {% csrf_token %}
            {{ s_form.as_p }}
        </form>

        <div id="sales-forms"></div>

        <div class="button-group">
            <button type="button" class="btn btn-success add-tablet-btn" hx-get="{% url 'create-sale' %}"
                hx-target="#sales-forms" hx-swap="beforeend">+ Add Tablet</button>

            <button id="sale-button" type="button" class="hidden btn btn-primary" onclick="activateSubmitAll()">Sale
                Order</button>
            <button id="delivery-button" type="button" class="hidden btn btn-primary"
                onclick="activateSubmitAll()">Print Delivery</button>
            <button type="button" class="btn btn-primary hidden" id="submit-all" onclick="proceed()">Submit All</button>
        </div>
    </div>
    <input type="hidden" id="delivery-id" value="{{ delivery.id }}">

    <script>
        function proceed() {
            document.getElementById('sa').submit();
        }

        function updateButton() {
            const orderType = document.getElementById('id_confirmed').value;
            const saleButton = document.getElementById('sale-button');
            const deliveryButton = document.getElementById('delivery-button');

            if (orderType === 'SALE COUNTER') {
                saleButton.classList.remove('hidden');
                deliveryButton.classList.add('hidden');
            } else if (orderType === 'SALE DELIVERY') {
                saleButton.classList.add('hidden');
                deliveryButton.classList.remove('hidden');
            } else {
                saleButton.classList.add('hidden');
                deliveryButton.classList.add('hidden');
            }
        }

        function activateSubmitAll() {
            const submitAllButton = document.getElementById('submit-all');
            submitAllButton.click()
            // submitAllButton.classList.remove('hidden');
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('id_confirmed').addEventListener('change', updateButton);
            updateButton(); // Initialize button visibility on page load
        });

        function updateCustomerImage() {
        const customerId = document.getElementById('id_customer').value;
        const customerImage = document.getElementById('customer-image');

        fetch(`/get_customer_image/${customerId}/`) // Assuming this endpoint returns the image URL
            .then(response => response.json())
            .then(data => {
                if (data.image_url) {
                    customerImage.src = data.image_url;
                    customerImage.classList.remove('hidden'); // Show the image if available
                } else {
                    // Use a default image if customer has no image
                    customerImage.src = '{% static "images/profile.jpeg" %}';
                    customerImage.classList.add('hidden'); // Hide the image if no image available
                }
            })
            .catch(error => {
                console.error('Error:', error);
                customerImage.src = '{% static "images/profile.jpeg" %}';
                customerImage.classList.add('hidden'); // Hide the image on error
            });
    }

    function printDelivery() {
    const deliveryId = document.getElementById('delivery-id').value;
    fetch(`/generate_pdf/${deliveryId}/`)
        .then(response => response.blob())
        .then(blob => {
            const url = window.URL.createObjectURL(new Blob([blob]));
            const link = document.createElement('a');
            link.href = url;
            link.setAttribute('download', 'delivery_report.pdf');
            document.body.appendChild(link);
            link.click();
            link.parentNode.removeChild(link);
        })
        .catch(error => console.error('Error:', error));
}
document.getElementById('delivery-button').addEventListener('click', printDelivery);


    </script>
</body>
</html>